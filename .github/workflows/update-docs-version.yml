name: Update Documentation Version

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (e.g., v0.9.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (show changes without committing)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  update-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.ref || github.ref_name }}
          fetch-depth: 0

      - name: Get current date
        id: date
        run: echo "date=$(date +'%B %Y')" >> $GITHUB_OUTPUT

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME}"
          fi
          echo "full=$VERSION" >> $GITHUB_OUTPUT
          echo "no_v=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Update documentation version numbers
        uses: richardrigutins/replace-in-files@v2
        with:
          files: 'docs/*.md'
          search-text: '\*\*Documentation Version\*\*: v[0-9]+\.[0-9]+\.[0-9]+'
          replacement-text: '**Documentation Version**: ${{ steps.version.outputs.full }}'
          encoding: 'utf8'

      - name: Update documentation dates
        uses: richardrigutins/replace-in-files@v2
        with:
          files: 'docs/*.md'
          search-text: '\*\*Last Updated\*\*: \w+ \d{4}'
          replacement-text: '**Last Updated**: ${{ steps.date.outputs.date }}'
          encoding: 'utf8'

      - name: Update Homebrew formula version
        uses: richardrigutins/replace-in-files@v2
        with:
          files: 'homebrew/pass-cli.rb'
          search-text: 'version "[0-9]+\.[0-9]+\.[0-9]+"'
          replacement-text: 'version "${{ steps.version.outputs.no_v }}"'
          encoding: 'utf8'

      - name: Update Scoop manifest version
        uses: richardrigutins/replace-in-files@v2
        with:
          files: 'scoop/pass-cli.json'
          search-text: '"version": "[0-9]+\.[0-9]+\.[0-9]+"'
          replacement-text: '"version": "${{ steps.version.outputs.no_v }}"'
          encoding: 'utf8'

      - name: Update root README.md version
        uses: richardrigutins/replace-in-files@v2
        with:
          files: 'README.md'
          search-text: '\*\*Version\*\*: v[0-9]+\.[0-9]+\.[0-9]+'
          replacement-text: '**Version**: ${{ steps.version.outputs.full }}'
          encoding: 'utf8'

      - name: Update root README.md date
        uses: richardrigutins/replace-in-files@v2
        with:
          files: 'README.md'
          search-text: '\*\*Last Updated\*\*: \w+ \d{4}'
          replacement-text: '**Last Updated**: ${{ steps.date.outputs.date }}'
          encoding: 'utf8'

      - name: Check if there are changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Show changes (dry run)
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry_run == true
        run: |
          echo "ðŸ“‹ Changes that would be made:"
          git diff

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry_run != true
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md docs/*.md homebrew/pass-cli.rb scoop/pass-cli.json
          git commit -m "docs: update version to ${{ steps.version.outputs.full }} and date to ${{ steps.date.outputs.date }}"

          # Push to current branch
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Tag push - push to main
            git push origin HEAD:main
          else
            # Manual trigger - push to current branch
            git push origin HEAD:"${BRANCH_NAME}"
          fi

      - name: Summary
        run: |
          echo "âœ… Documentation updated to version ${{ steps.version.outputs.full }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Date updated to ${{ steps.date.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            echo "ðŸ” DRY RUN - No changes committed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            if [[ "${{ github.event_name }}" == "push" ]]; then
              echo "ðŸ“ Changes committed and pushed to main branch" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸ“ Changes committed and pushed to ${GITHUB_REF#refs/heads/}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â„¹ï¸ No changes needed - docs already up to date" >> $GITHUB_STEP_SUMMARY
          fi
