name: Update Documentation Version

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  update-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Get current date
        id: date
        run: echo "date=$(date +'%B %Y')" >> $GITHUB_OUTPUT

      - name: Extract version without 'v' prefix
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Update documentation version numbers
        uses: richardrigutins/replace-in-files@v2
        with:
          files: 'docs/*.md'
          search-text: '\*\*Documentation Version\*\*: v[0-9]+\.[0-9]+\.[0-9]+'
          replacement-text: '**Documentation Version**: ${{ github.ref_name }}'
          encoding: 'utf8'

      - name: Update documentation dates
        uses: richardrigutins/replace-in-files@v2
        with:
          files: 'docs/*.md'
          search-text: '\*\*Last Updated\*\*: \w+ \d{4}'
          replacement-text: '**Last Updated**: ${{ steps.date.outputs.date }}'
          encoding: 'utf8'

      - name: Update Homebrew formula version
        uses: richardrigutins/replace-in-files@v2
        with:
          files: 'homebrew/pass-cli.rb'
          search-text: 'version "[0-9]+\.[0-9]+\.[0-9]+"'
          replacement-text: 'version "${{ steps.version.outputs.version }}"'
          encoding: 'utf8'

      - name: Update Scoop manifest version
        uses: richardrigutins/replace-in-files@v2
        with:
          files: 'scoop/pass-cli.json'
          search-text: '"version": "[0-9]+\.[0-9]+\.[0-9]+"'
          replacement-text: '"version": "${{ steps.version.outputs.version }}"'
          encoding: 'utf8'

      - name: Check if there are changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/*.md homebrew/pass-cli.rb scoop/pass-cli.json
          git commit -m "docs: update version to ${{ github.ref_name }} and date to ${{ steps.date.outputs.date }}"
          git push origin HEAD:main

      - name: Summary
        run: |
          echo "âœ… Documentation updated to version ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Date updated to ${{ steps.date.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            echo "ðŸ“ Changes committed and pushed to main branch" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No changes needed - docs already up to date" >> $GITHUB_STEP_SUMMARY
          fi
